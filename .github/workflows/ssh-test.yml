name: SSH Test

on:
  workflow_dispatch:

jobs:
  ssh-test:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH tunnel to database
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          mkdir -p ~/.ssh
          printf "%s" "$SSH_PRIVATE_KEY" > ~/.ssh/id_live
          chmod 600 ~/.ssh/id_live

          ssh-keyscan -T 10 -p ${SSH_PORT:-22} ${SSH_HOST} >> ~/.ssh/known_hosts

          # ğŸ”¥ ConoHa MySQL ã«æ¥ç¶šã™ã‚‹ã«ã¯å†…éƒ¨IPã¸ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
          #    mysql1023.conoha.ne.jp â†’ 172.22.44.179ï¼ˆå†…éƒ¨å°‚ç”¨ï¼‰
          ssh -i ~/.ssh/id_live \
            -o StrictHostKeyChecking=no \
            -o ExitOnForwardFailure=yes \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=3 \
            -fN \
            -L 3307:172.22.44.179:3306 \
            ${SSH_USER}@${SSH_HOST} -p ${SSH_PORT}

      - name: Verify tunnel
        run: ss -lntp

      - name: Test MySQL connection
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          mysql -u "${DB_USER}" \
                -p"${DB_PASSWORD}" \
                -h 127.0.0.1 \
                -P 3307 \
                "${DB_NAME}" \
                -e "SHOW TABLES;"
